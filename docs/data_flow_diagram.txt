================================================================================
                    DATA FLOW DIAGRAM - PRODUCT NAMES
================================================================================

                    Current System vs Proposed System
                    With Set Decoding and Manual Addition

================================================================================


LEGEND:
─────────────────────────────────────────────────────────────────────────
  [Box]        = Data source / Process / Output
  ────>        = Data flow direction
  ┌──┐         = Process / Transformation
  │  │
  └──┘
  ═══>         = Proposed new flow
  !!!          = Problem / Data loss
  ✓            = Fixed / Correct behavior
─────────────────────────────────────────────────────────────────────────


================================================================================
                        CURRENT SYSTEM (BROKEN)
================================================================================

STEP 1: Load Orders
────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Orders CSV (from Shopify)                                  │
│                                                             │
│  Order | SKU           | Lineitem name                     │
│  ─────────────────────────────────────────────────────────  │
│  1001  | SET-WINTER    | "Winter Bundle Gift Set"          │
│  1002  | SKU-REGULAR   | "Regular Product"                 │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Apply column mappings
                           │ "Lineitem name" → "Product_Name"
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Orders DataFrame (after mapping)                           │
│                                                             │
│  Order_Number | SKU           | Product_Name               │
│  ──────────────────────────────────────────────────────────  │
│  1001         | SET-WINTER    | "Winter Bundle Gift Set"   │
│  1002         | SKU-REGULAR   | "Regular Product"          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 2: Decode Sets
────────────────────

┌────────────────────────────────────────────────────────────────┐
│  Set Decoder Rules                                             │
│                                                                │
│  SET-WINTER → [ {sku: SKU-HAT, qty: 1},                      │
│                 {sku: SKU-GLOVES, qty: 1},                    │
│                 {sku: SKU-SCARF, qty: 1} ]                    │
└────────────────────────────────────────────────────────────────┘
                           │
                           │ Expand set into components
                           │ row.copy() ← COPIES Product_Name!
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Orders DataFrame (after set decoding)                      │
│                                                             │
│  Order | SKU          | Product_Name                       │
│  ──────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT      | "Winter Bundle..." !!! WRONG!     │
│  1001  | SKU-GLOVES   | "Winter Bundle..." !!! WRONG!     │
│  1001  | SKU-SCARF    | "Winter Bundle..." !!! WRONG!     │
│  1002  | SKU-REGULAR  | "Regular Product"                 │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 3: Load Stock
──────────────────

┌─────────────────────────────────────────────────────────────┐
│  Stock CSV (from Warehouse)                                 │
│                                                             │
│  Артикул      | Име                      | Наличност       │
│  ──────────────────────────────────────────────────────────  │
│  SKU-HAT      | "Зимова шапка"           | 50             │
│  SKU-GLOVES   | "Рукавички"              | 30             │
│  SKU-SCARF    | "Шарф"                   | 0              │
│  SKU-REGULAR  | "Regular Stock Name"     | 100            │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Apply column mappings
                           │ "Артикул" → "SKU"
                           │ "Име" → "Product_Name"  !!! CONFLICT!
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Stock DataFrame (after mapping)                            │
│                                                             │
│  SKU          | Product_Name             | Stock           │
│  ──────────────────────────────────────────────────────────  │
│  SKU-HAT      | "Зимова шапка"           | 50             │
│  SKU-GLOVES   | "Рукавички"              | 30             │
│  SKU-SCARF    | "Шарф"                   | 0              │
│  SKU-REGULAR  | "Regular Stock Name"     | 100            │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 4: Merge (PROBLEM!)
─────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Merge Logic (analysis.py:240-245)                          │
│                                                             │
│  final_df = pd.merge(                                       │
│      orders_clean_df,                                       │
│      stock_clean_df,                                        │
│      on="SKU",                                              │
│      how="left",                                            │
│      suffixes=('', '_stock')  ← Creates Product_Name_stock │
│  )                                                          │
│                                                             │
│  if 'Product_Name_stock' in final_df.columns:              │
│      final_df = final_df.drop(columns=['Product_Name_stock'])│
│                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^          │
│                     !!! STOCK NAMES LOST !!!                │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Stock Product_Name dropped!
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Final DataFrame (BROKEN)                                   │
│                                                             │
│  Order | SKU          | Product_Name        | Stock        │
│  ──────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT      | "Winter Bundle..."  | 50  !!! WRONG│
│  1001  | SKU-GLOVES   | "Winter Bundle..."  | 30  !!! WRONG│
│  1001  | SKU-SCARF    | "Winter Bundle..."  | 0   !!! WRONG│
│  1002  | SKU-REGULAR  | "Regular Product"   | 100          │
│                                                             │
│  Problem: Warehouse staff see "Winter Bundle..." for       │
│  all components instead of actual product names!           │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 5: Generate Reports
──────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Packing List (packing_lists.py)                            │
│                                                             │
│  Order | SKU          | Product_Name        | Qty          │
│  ──────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT      | "Winter Bundle..."  | 1  !!! WRONG│
│  1001  | SKU-GLOVES   | "Winter Bundle..."  | 1  !!! WRONG│
│  1001  | SKU-SCARF    | "Winter Bundle..."  | 1  !!! WRONG│
│                                                             │
│  Warehouse worker confused: "Where is Winter Bundle??"      │
│  They need to see: "Зимова шапка", "Рукавички", "Шарф"     │
└─────────────────────────────────────────────────────────────┘


================================================================================
                      PROPOSED SYSTEM (FIXED)
================================================================================

STEPS 1-3: Same as before (Load Orders, Decode Sets, Load Stock)

STEP 4: Merge + Add Warehouse_Name (NEW!)
──────────────────────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Merge Logic (analysis.py:240-250) - MODIFIED               │
│                                                             │
│  # Merge as before                                          │
│  final_df = pd.merge(                                       │
│      orders_clean_df,                                       │
│      stock_clean_df,                                        │
│      on="SKU",                                              │
│      how="left",                                            │
│      suffixes=('', '_stock')                                │
│  )                                                          │
│                                                             │
│  # Drop Product_Name_stock (as before)                      │
│  if 'Product_Name_stock' in final_df.columns:              │
│      final_df = final_df.drop(columns=['Product_Name_stock'])│
│                                                             │
│  # === NEW CODE STARTS HERE ===                             │
│                                                             │
│  # Create stock lookup dictionary                           │
│  if "Product_Name" in stock_clean_df.columns:              │
│      stock_lookup = dict(zip(                              │
│          stock_clean_df["SKU"],                            │
│          stock_clean_df["Product_Name"]                    │
│      ))                                                     │
│                                                             │
│      # Add Warehouse_Name column by mapping SKU             │
│      final_df["Warehouse_Name"] = final_df["SKU"].map(      │
│          stock_lookup                                       │
│      )                                                      │
│                                                             │
│      # Fill N/A for SKUs not in stock                       │
│      final_df["Warehouse_Name"] = final_df["Warehouse_Name"]│
│                                       .fillna("N/A")        │
│  else:                                                      │
│      final_df["Warehouse_Name"] = "N/A"                    │
│                                                             │
│  logger.info("Added Warehouse_Name column from stock")     │
│                                                             │
│  # === NEW CODE ENDS HERE ===                               │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Stock names preserved!
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Final DataFrame (FIXED) ✓                                  │
│                                                             │
│  Order | SKU       | Product_Name     | Warehouse_Name | Stock│
│  ────────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT   | "Winter Bundle"  | "Зимова шапка" | 50 ✓│
│  1001  | SKU-GLOVES| "Winter Bundle"  | "Рукавички"    | 30 ✓│
│  1001  | SKU-SCARF | "Winter Bundle"  | "Шарф"         | 0  ✓│
│  1002  | SKU-REG   | "Regular Prod"   | "Regular Stock"| 100✓│
│                                                             │
│  ✓ Product_Name: Shows Shopify name (for reference)        │
│  ✓ Warehouse_Name: Shows actual product name from stock    │
│  ✓ Both names preserved!                                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 5: Generate Reports (Updated)
───────────────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Packing List (packing_lists.py) - UPDATED                  │
│                                                             │
│  Order | SKU          | Warehouse_Name     | Qty           │
│  ──────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT      | "Зимова шапка"     | 1  ✓         │
│  1001  | SKU-GLOVES   | "Рукавички"        | 1  ✓         │
│  1001  | SKU-SCARF    | "Шарф"             | 1  ✓         │
│                                                             │
│  ✓ Warehouse worker sees correct product names!            │
│  ✓ Clear picking instructions!                             │
└─────────────────────────────────────────────────────────────┘


================================================================================
                    MANUAL PRODUCT ADDITION FLOW
================================================================================

SCENARIO: User wants to add a gift item to an order after analysis

STEP 1: User Interface
──────────────────────

┌─────────────────────────────────────────────────────────────┐
│  MainWindow (after analysis complete)                       │
│                                                             │
│  [Run Analysis] [➕ Add Product to Order] [Settings]       │
│                        ▲                                    │
│                        │ User clicks                        │
│                        │                                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 2: Dialog Opens
────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Add Product Dialog                                         │
│                                                             │
│  Select Order:   [1001 (3 items, Fulfillable) ▼]          │
│                                                             │
│  Select Product: [SKU-GIFT - Gift Box (100) ▼]            │
│                                                             │
│  Quantity:       [1]                                        │
│                                                             │
│  [Cancel]  [Add Product]                                   │
│                     │                                       │
│                     │ User selects and clicks               │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 3: Validation
──────────────────

┌─────────────────────────────────────────────────────────────┐
│  Dialog Validation                                          │
│                                                             │
│  ✓ Order selected: 1001                                    │
│  ✓ Product selected: SKU-GIFT                              │
│  ✓ Quantity valid: 1 (between 1-9999)                      │
│  ⚠️ Stock check: 100 available (OK)                        │
│                                                             │
│  Result: {                                                  │
│    "order_number": "1001",                                 │
│    "sku": "SKU-GIFT",                                      │
│    "product_name": "Gift Box",                             │
│    "quantity": 1                                           │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Validation passed
                           ▼

STEP 4: Add to DataFrame
─────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  ActionsHandler.add_product_to_order()                      │
│                                                             │
│  # Create new row                                           │
│  new_row = {                                                │
│      "Order_Number": "1001",                               │
│      "SKU": "SKU-GIFT",                                    │
│      "Quantity": 1,                                        │
│      "Product_Name": "Gift Box",                           │
│      "Warehouse_Name": "Gift Box",                         │
│      "Source": "Manual",  ← NEW COLUMN                     │
│      "Order_Fulfillment_Status": "Pending",                │
│      # ... other columns with defaults                      │
│  }                                                          │
│                                                             │
│  # Append to DataFrame                                      │
│  analysis_df = pd.concat([analysis_df, pd.DataFrame([new_row])])│
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 5: Save to Session
────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Session Folder                                             │
│  /Sessions/CLIENT_M/SESSION_20251113_143022/                │
│                                                             │
│  manual_additions.json  ← NEW FILE                          │
│  {                                                          │
│    [                                                        │
│      {                                                      │
│        "order_number": "1001",                             │
│        "sku": "SKU-GIFT",                                  │
│        "product_name": "Gift Box",                         │
│        "quantity": 1,                                      │
│        "timestamp": "2025-11-13T14:32:15"                  │
│      }                                                      │
│    ]                                                        │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Persisted for future sessions
                           ▼

STEP 6: Update UI
─────────────────

┌─────────────────────────────────────────────────────────────┐
│  MainWindow - Analysis Data Tab (Updated)                   │
│                                                             │
│  Order | SKU       | Product_Name | Warehouse | Qty | Source│
│  ────────────────────────────────────────────────────────────  │
│  1001  | SKU-HAT   | "Winter..."  | "Зимова"  | 1   | Order│
│  1001  | SKU-GLOVES| "Winter..."  | "Рукавич" | 1   | Order│
│  1001  | SKU-SCARF | "Winter..."  | "Шарф"    | 1   | Order│
│  1001  | SKU-GIFT  | "Gift Box"   | "Gift Box"| 1   | Manual│ ← NEW
│  1002  | SKU-REG   | "Regular"    | "Regular" | 1   | Order│
│                                                             │
│  ✓ Manual addition visible in table                        │
│  ✓ Source column shows "Manual" vs "Order"                 │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 7: Success Message
────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  ✓ Success                                                  │
│                                                             │
│  Product SKU-GIFT added to order 1001.                     │
│                                                             │
│  Note: You may want to re-run analysis to                  │
│  update fulfillment status.                                │
│                                                             │
│  [OK]                                                       │
└─────────────────────────────────────────────────────────────┘


================================================================================
                    RE-RUN ANALYSIS WITH MANUAL ADDITIONS
================================================================================

When user re-runs analysis after manual additions:

STEP 1: Load Session
────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Load Previous Session                                      │
│                                                             │
│  1. Load orders CSV                                         │
│  2. Load stock CSV                                          │
│  3. Load manual_additions.json ← LOAD MANUAL ADDITIONS     │
│                                                             │
│  manual_additions = [                                       │
│      {"order_number": "1001", "sku": "SKU-GIFT", "qty": 1} │
│  ]                                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │
                           ▼

STEP 2: Apply Manual Additions
───────────────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Apply Manual Additions to Orders DataFrame                 │
│                                                             │
│  for addition in manual_additions:                          │
│      new_row = {                                            │
│          "Order_Number": addition["order_number"],          │
│          "SKU": addition["sku"],                            │
│          "Quantity": addition["quantity"],                  │
│          "Product_Name": get_from_stock(addition["sku"]),  │
│          # ... other fields                                 │
│      }                                                      │
│      orders_df = pd.concat([orders_df, pd.DataFrame([new_row])])│
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Manual additions merged with orders
                           ▼

STEP 3: Run Analysis
────────────────────

┌─────────────────────────────────────────────────────────────┐
│  Regular Analysis Process                                   │
│                                                             │
│  - Decode sets                                              │
│  - Merge with stock                                         │
│  - Add Warehouse_Name column                                │
│  - Simulate fulfillment                                     │
│  - Generate reports                                         │
│                                                             │
│  Manual additions treated like regular order items!        │
└─────────────────────────────────────────────────────────────┘


================================================================================
                            SUMMARY DIAGRAM
================================================================================

BEFORE (Broken):
Orders → Sets Decoded → Merge with Stock → Drop Stock Names → WRONG NAMES

AFTER (Fixed):
Orders → Sets Decoded → Merge with Stock → Preserve Stock Names → CORRECT NAMES
                                          └─> Add Warehouse_Name column ✓

MANUAL ADD:
User clicks → Dialog → Validate → Add Row → Save to Session → Update UI ✓

RE-ANALYSIS:
Load Orders → Load Manual Additions → Merge → Analysis → Reports ✓


================================================================================
                            END OF DIAGRAM
================================================================================
