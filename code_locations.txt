DELIMITER-RELATED CODE LOCATIONS
================================================================================

Last Updated: 2025-11-12
Purpose: Quick reference for all delimiter-related code in the codebase

================================================================================
PANDAS READ_CSV CALLS
================================================================================

Production Code:
----------------

1. gui/file_handler.py:73
   Context: Stock file validation after selection
   Code: stock_df = pd.read_csv(filepath, delimiter=delimiter)
   Delimiter: From config (parameter)
   Encoding: ❌ NOT SPECIFIED
   Error Handling: ✓ Try/except (lines 72-85)
   Issues: Missing encoding

2. shopify_tool/core.py:185
   Context: CSV header validation
   Code: headers = pd.read_csv(file_path, nrows=0, delimiter=delimiter).columns.tolist()
   Delimiter: From parameter (default ",")
   Encoding: ❌ NOT SPECIFIED
   Error Handling: ✓ Try/except (lines 184-200)
   Issues: Missing encoding

3. shopify_tool/core.py:329
   Context: Main stock data loading in run_full_analysis()
   Code: stock_df = pd.read_csv(stock_file_path, delimiter=stock_delimiter)
   Delimiter: From parameter (passed from config)
   Encoding: ❌ NOT SPECIFIED
   Error Handling: ❌ NO TRY/EXCEPT
   Issues: Missing encoding, missing error handling

4. shopify_tool/core.py:331
   Context: Main orders data loading in run_full_analysis()
   Code: orders_df = pd.read_csv(orders_file_path)
   Delimiter: ❌ HARDCODED "," (pandas default)
   Encoding: ❌ NOT SPECIFIED
   Error Handling: ❌ NO TRY/EXCEPT
   Issues: Hardcoded delimiter, missing encoding, missing error handling

5. shopify_tool/core.py:366
   Context: Loading fulfillment history
   Code: history_df = pd.read_csv(history_path_str)
   Delimiter: Default "," (pandas default)
   Encoding: ❌ NOT SPECIFIED
   Error Handling: ⚠️ Partial (FileNotFoundError only, lines 360-373)
   Issues: Missing encoding, incomplete error handling

Test Code:
----------

6. tests/test_core.py:275
   Context: Test history loading
   Code: history_df = pd.read_csv(history_file)

7. tests/integration/test_migration.py:298
   Context: Test orders loading verification
   Code: copied_orders = pd.read_csv(input_dir / "orders_export.csv")

8. tests/integration/test_migration.py:301
   Context: Test stock loading verification
   Code: copied_stock = pd.read_csv(input_dir / "inventory.csv", sep=";")

================================================================================
CONFIGURATION LOCATIONS
================================================================================

Stock Delimiter Config Keys:
-----------------------------

INCONSISTENCY ALERT: Two different keys used!

1. shopify_tool/profile_manager.py:438
   Key: "stock_delimiter"
   Default: ";"
   Context: Template default configuration

2. gui/settings_window_pyside.py:183-184
   Key: "stock_csv_delimiter"
   Default: ";"
   Context: Settings UI

3. gui/file_handler.py:69
   Key: "stock_csv_delimiter"
   Default: ";"
   Context: File selection and validation

4. gui/file_handler.py:135
   Key: "stock_csv_delimiter"
   Default: ";"
   Context: Stock file validation

5. gui/actions_handler.py:115
   Key: "stock_delimiter"
   Default: ";"
   Context: Running analysis (passing to core)

Orders Delimiter:
-----------------

❌ NO CONFIGURATION EXISTS - Always hardcoded to ","

Hardcoded locations:
1. gui/file_handler.py:118 - delimiter = ","
2. shopify_tool/core.py:331 - No parameter (pandas default = ",")

================================================================================
DELIMITER PARAMETER FLOW
================================================================================

Stock Delimiter Flow:
---------------------

1. USER CONFIGURATION
   Settings UI (settings_window_pyside.py:183-184)
   → saves to config["settings"]["stock_csv_delimiter"]

2. FILE SELECTION
   File Handler (file_handler.py:69)
   → reads config["settings"]["stock_csv_delimiter"]
   → validates file with delimiter

3. ANALYSIS EXECUTION
   Actions Handler (actions_handler.py:115)
   → reads config["settings"]["stock_delimiter"]  ← DIFFERENT KEY!
   → passes to run_full_analysis()

4. CSV LOADING
   Core (core.py:329)
   → receives stock_delimiter parameter
   → loads CSV with pd.read_csv(..., delimiter=stock_delimiter)

Orders Delimiter Flow:
----------------------

1. USER CONFIGURATION
   ❌ Not available

2. FILE SELECTION
   File Handler (file_handler.py:118)
   → hardcoded delimiter = ","

3. ANALYSIS EXECUTION
   Actions Handler (actions_handler.py)
   → no orders_delimiter parameter

4. CSV LOADING
   Core (core.py:331)
   → no delimiter parameter = pandas default ","

================================================================================
VALIDATION FUNCTIONS
================================================================================

1. shopify_tool/core.py:161-200
   Function: validate_csv_headers(file_path, required_columns, delimiter=",")
   Purpose: Check if CSV has required columns
   Delimiter: Parameter with default ","
   Encoding: ❌ NOT SPECIFIED
   Used by: gui/file_handler.py:154

2. shopify_tool/core.py:138-158
   Function: _validate_dataframes(orders_df, stock_df, config)
   Purpose: Validate DataFrames after loading
   Note: Validation happens AFTER CSV parsing, so wrong delimiter would fail earlier

================================================================================
ERROR HANDLING LOCATIONS
================================================================================

Good Error Handling:
--------------------

1. gui/file_handler.py:72-85
   Context: Stock file loading
   Catches: Exception (generic)
   UI: QMessageBox.critical with helpful message including delimiter hint
   Code:
   ```python
   try:
       stock_df = pd.read_csv(filepath, delimiter=delimiter)
       self.log.info(f"Loaded stock CSV with delimiter '{delimiter}': {len(stock_df)} rows")
   except Exception as e:
       self.log.error(f"Failed to load stock CSV: {e}")
       QMessageBox.critical(
           self.mw,
           "File Load Error",
           f"Failed to load stock file:\n{str(e)}\n\n"
           f"Make sure the delimiter is set correctly in Settings.\n"
           f"Current delimiter: '{delimiter}'"
       )
       return
   ```

2. shopify_tool/core.py:184-200
   Context: CSV header validation
   Catches: FileNotFoundError, pd.errors.ParserError, Exception
   Returns: (False, [error_message])
   Good: Specific error types with appropriate messages

Missing Error Handling:
-----------------------

1. shopify_tool/core.py:329
   Context: Stock CSV loading in run_full_analysis()
   Issue: No try/except, will crash on parse error

2. shopify_tool/core.py:331
   Context: Orders CSV loading in run_full_analysis()
   Issue: No try/except, will crash on parse error

3. shopify_tool/core.py:366
   Context: History CSV loading
   Issue: Only catches FileNotFoundError, not ParserError or other exceptions

================================================================================
UI ELEMENTS
================================================================================

Settings Window:
----------------

Location: gui/settings_window_pyside.py:181-197

Stock Delimiter Setting:
- Label: "Stock CSV Delimiter:"
- Widget: QLineEdit (self.stock_delimiter_edit)
- Config key: "stock_csv_delimiter"
- Default: ";"
- Tooltip: Helpful explanation with common values
- Max width: 100px

Orders Delimiter Setting:
- ❌ DOES NOT EXIST

File Handler Status Labels:
---------------------------

Location: gui/file_handler.py

Orders File Status (line 117):
- Label: self.mw.orders_file_status_label
- Values: "✓" (green) or "✗" (red)
- Tooltip: Error details if invalid

Stock File Status (line 134):
- Label: self.mw.stock_file_status_label
- Values: "✓" (green) or "✗" (red)
- Tooltip: Error details if invalid

================================================================================
TO_CSV OPERATIONS (for comparison)
================================================================================

Note: All CSV write operations DO specify encoding (utf-8 or utf-8-sig)
      But CSV read operations do NOT!

1. scripts/create_comprehensive_test_data.py:829
   Code: df.to_csv(output_path, index=False, sep=";", encoding='utf-8-sig')

2. scripts/create_test_data.py:110
   Code: df.to_csv(output_path, index=False, sep=";", encoding='utf-8')

3. tests/test_core_session_integration.py:82
   Code: stock_df.to_csv(stock_file, index=False, sep=";")

4. tests/integration/test_migration.py:97
   Code: stock_df.to_csv(stock_file, index=False, sep=";")

================================================================================
SUMMARY STATISTICS
================================================================================

Read CSV Calls:
- Total: 8 (3 production, 5 test)
- With encoding specified: 0 (0%)
- With delimiter parameter: 3 (37.5%)
- With hardcoded delimiter: 2 (25%)
- With error handling: 3 (37.5%)

Configuration Keys:
- Stock delimiter keys: 2 different keys used (inconsistent!)
- Orders delimiter keys: 0 (not configurable)

Error Handling:
- Good error handling: 2 locations (file_handler, validate_csv_headers)
- Missing error handling: 3 locations (core CSV loading)

UI Elements:
- Stock delimiter settings: 1 (exists)
- Orders delimiter settings: 0 (missing)

================================================================================
PRIORITY FIXES NEEDED
================================================================================

1. Add encoding='utf-8-sig' to ALL read_csv calls (8 locations)
2. Add error handling to core.py lines 329, 331, 366
3. Standardize config key (choose one: stock_delimiter or stock_csv_delimiter)
4. Add orders delimiter configuration (4 locations + UI)
5. Implement automatic delimiter detection

See DELIMITER_DETECTION_AUDIT.md for detailed recommendations.

================================================================================
END OF CODE LOCATIONS REFERENCE
================================================================================
